<html>
<head>
    <title>What's happening right now - Groundstream.org</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>  
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
    <script src="http://maps.google.com/maps/api/js?sensor=false"></script>
    <script type="text/javascript">
		var DEBUG = false;
        var Services = [
            {   
				name: "twitpic",
                domain: "twitpic.com",
                sample: "http://twitpic.com/123456", 
                transform: function(url){ return url.replace("twitpic.com/", "twitpic.com/show/large/") }
            },
        //    {   
		//		  domain: "instagr.am",
        //        sample: "http://instagr.am/p/CIW2h", 
        //        transform: function(url){ return url+'/media?size=m'; }
        //    },
            {   
				name: "yfrog",
                domain: "yfrog.com",
                sample: "http://yfrog.com/12345678", 
                transform: function(url){ return url+':medium' }
            }
		//	,
		//	{
		//		name: "tco",
		//		domain: "t.co",
		//		sample: "http://t.co/L9QFnRp9",
		//		transform: function(url) { return url }
		//	}
        ];
    
        $(function() {
            // get lat/lon from place
            if(window.location.hash)
                $('#woof').val(window.location.hash.replace('#', ''));
        
            var run_timeout; // instant search: save the httprequest so we can kill it
            var searchPlace = $('#woof').val();
            
            run(searchPlace);
            
            $('#woof').keyup(function(event) {
                clearTimeout(run_timeout);
                searchPlace = $('#woof').val();

                // when a key is struck, clear the future RUN call
                if(run_timeout) {
                    if(DEBUG) console.log('abort!'); 
                    run_timeout.abort;
                }
                
                if(event.keyCode == 13) {
                    // return key
                    run_timeout.abort;
                    run(searchPlace);
                } else if(event.keyCode >= 65 && event.keyCode <= 90)  {
                    run_timeout = setTimeout(function(){run(searchPlace)}, 500);
                }
            });
        });
        
        // can't bind or live the error method, unfortunately. bug in safari, firefox, etc
        // http://forum.jquery.com/topic/error-event-with-live
		// have to hack it in: <img onerror="javascript:imgErr(this)" ...
        function imgErr(thing) {
			// if we're in prod, hide all broken images
            if(!DEBUG) $(thing).parent().parent().css('display', 'none');
        }
        
        function stopLoading() {
            if(window.stop !== undefined)
            {
                 window.stop();
            }
            else if(document.execCommand !== undefined)
            {
                 document.execCommand("Stop", false);
            }
        }
        
        var runcount = 0;
        
        function run(searchPlace) {
            if(DEBUG) console.log('run '+runcount++);
            
            var geocoder = new google.maps.Geocoder();

            window.location.hash = searchPlace;
			if(DEBUG) console.log(searchPlace);

            $('#crunch').html('loading!');
            
            if(geocoder) {
                
                geocoder.geocode({ 'address': searchPlace }, function (results, status) {
                    if (status == google.maps.GeocoderStatus.OK) {
                        var lat = results[0].geometry.location.lat();
                        var lon = results[0].geometry.location.lng();

                        if(DEBUG) console.log('searching around '+lat+','+lon);
                        search(lat+','+lon);
                    }
                    else {
                        if(DEBUG) console.log("Geocoding failed: " + status);
                    }
                });
            }
        }
        
        function search(location) {
            if(DEBUG) console.log('waiting for response...');
        
            var place = location;
            var accuracy = '100';
            var extras = '';
        
            // if(getUrlVars()[0] == 'a') {
            //     accuracy = getUrlVars();
            //     if(DEBUG) console.log('accuracy: '+accuracy);
            // }
            
            place = place+','+accuracy+'mi';
        
            var query = "http://search.twitter.com/search.json?q=twitpic OR yfrog "+extras+"&geocode="+place+"&rpp=100&include_entities=true";
            if(DEBUG) console.log(query);
        
            var fetch = $.ajax({
                type:'GET',
                url:query,
                data:"callback=?",
                success:function(feed) {
                    if(DEBUG) console.log('parsing...');
                    $('#crunch').html('');
                    
                    var tweets = [];
                    for(var i=0; i<feed.results.length; i++) {
                        tweets.push(feed.results[i]);
                    }
                    
                    render(tweets);   
                },
                dataType:'jsonp'
            });
        }
        
        function render(tweets) {
            var seen = []; // keep a list of urls we've seen so we don't repeat
            var tweet;
            var service;
			
			// loop all tweets
			// don't change this to a foreach, it's done like this on purpose
            for(var i=0; i<tweets.length; i++) {
                tweet = tweets[i];
                
				// loop each service
				// don't change this to a foreach, it's done like this on purpose
                for(var j=0; j<Services.length; j++) {
                    service = Services[j];
                    var url, location, size, img;


					if(DEBUG) console.log(tweet);

					if(typeof tweet.entities.urls == 'undefined') {
						// someone just said "twitpic" or somesuch, no actual url
						break;
					}
					
					// TODO: only works with the first url in the tweet. should work with all urls (more than one twitpic)
					if(typeof tweet.entities.urls[0].expanded_url != 'undefined') {
						url = tweet.entities.urls[0].expanded_url;
					} else {
						url = tweet.entities.urls[0].url;
					}
					
					// save the url in the tweet for easyness later
					tweet.gs_url = url;
					if(url.indexOf(service['domain']) > 0) {
                
                        img = service['transform'](url);
						tweet.gs_thumbnail = img;
                    
                        // be sure we haven't seen this one before
                        // (filters out RTs)
                        if($.inArray(img, seen) < 0) {
                            seen.push(img);
                            
                            var now = new Date();
                            var then = new Date(tweet.created_at);
                            var diff = .001 * (now.getTime() - then.getTime());
                            
                            if(diff < 60)
                                diff = Math.round(diff) + ' seconds';
                            else if(diff < 120)
                                diff = '1 minute';
                            else if(diff < 60*60)
                                diff = Math.round(diff/60) + ' minutes';
                            else if(diff < 60*60*24)
                                diff = Math.round((diff/60)/24) + ' hours';
                            else
                                diff = Math.round(((diff/60)/24)/7) + ' days';
                            
                            $('#crunch').append(tweetHTML(tweet, diff));
                        }
                        // found the right service. done with this tweet.
                        break;
                    }
                }
            }
        }

		// Gets the first URL written in a tweet
		function parseURL(tweet, service) {
			if(tweet.text.indexOf(service['domain']) == 0) {
				return false;
			}
			var location = tweet.text.indexOf("http:");
            var size = service['sample'].length;
            return tweet.text.substring(location, location+size);
		}
        
        function tweetHTML(tweet, time) {
			var big_url = tweet.gs_url
			var thumb_url = tweet.gs_thumbnail;
            return '<div class="img"><a href="'+big_url+'"><img onerror="javascript:imgErr(this)" src="'+thumb_url+'"></a><br />'+time+' ago</div>';
        }

		function groundstreamString(town) {
			$('#woof').val(town);
			run(town);
		}
        
        
        function getUrlVars()
        {
            var vars = [], hash;
            var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
            for(var i = 0; i < hashes.length; i++)
            {
                hash = hashes[i].split('=');
                vars.push(hash[0]);
                vars[hash[0]] = hash[1];
            }
            return vars;
        }
     </script>

	<style type="text/css">
        body {
            margin: 0px;
            padding: 0;
			/* Set this for mobile */
/*            width: 320px;*/
            font-family: "Minion Pro", Arial, sans-serif;
            background-color: #d7faff;
        }
		body, a {
			font-family: Helvetica, Arial, sans-serif;
            font-size: 14px;
            color: #888;
		}
        .img {
            float: left;
            margin: 10px;
            padding: 10px;
            width: 280px;
            border: 1px solid #ccc;
			line-height: 20px;
        }
        .img img {
            width: 280px;
        }
		#crunch {
			margin-top: 70px;
		}

		#top {
			margin-left: 10px;
            color: #666;
            font-size: 15px;
            position: fixed;
            background-color: #d7faff;

            display: block !important;
            width: 100%;
            padding: 10px 10px 0 10px;
            margin-top: 0;
			height: 43px;
		}
		.cell {
			width: 320px;
			float: left;
		}
		.cell-1 {
			width: 165px;
		}
		.cell-2 {
			width: 205px;
		}
		.cell-3 {
			width: 600px;
		}
        input {
            font-family: Helvetica, Arial, sans-serif;
            font-size: 10px;
            color: #888;

            padding: 5px 2px 3px 2px;
            font-size: 14px;
            border-top: 1px solid #666;
            border-right: 1px solid #888;
            border-bottom: 1px solid #888;
            border-left: 1px solid #aaa;
        }
        h2 {
            margin-left: 10px;
            color: #888;
            font-size: 16px;
        }
        ul {
			list-style-type: none;
			margin-top: 5px;
		}
		li {
			display: inline;
			margin-right: 30px;
		}
        .clearfix:after {
            content: ".";
            display: block;
            height: 0;
            clear: both;
            visibility: hidden;
        }
    </style>
</head>
<body>
    <div id="top">
		<div class="cell cell-1">
			<img src="earth.png" alt="Groundstream">
		</div>
		<div class="cell cell-2">
			<input id="woof" type="text" title="location" value="Tokyo" />
		</div>
		<div class="cell cell-3">
			<ul>
				<li>
					<a href="#san-francisco" onClick="groundstreamString('san francisco')">san francisco</a>
				</li>
				<li>
					<a href="#boise" onClick="groundstreamString('boise')">boise</a>
				</li>
				<li>
					<a href="#new-orleans" onClick="groundstreamString('new-orleans')">new orleans</a>
				</li>
				<li>
					<a href="#paris" onClick="groundstreamString('paris')">paris</a>
				</li>
				<li>
					<a href="#singapore" onClick="groundstreamString('singapore')">singapore</a>
				</li>
				<li>
					<a href="#bangkok" onClick="groundstreamString('bangkok')">bangkok</a>
				</li>
			</ul>
		</div>
        
    </div>

	<div class="clearfix"></div>
    
    <div id="crunch"></div>
    
    <div class="clearfix"></div>
    <p>
        made by <a href="http://twitter.com/reed">reed morse<a><br />
        my day job is <a href="http://getpunchd.com" title="customer loyalty program">punchd</a>
    </p>
</body>
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-22359785-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</html>